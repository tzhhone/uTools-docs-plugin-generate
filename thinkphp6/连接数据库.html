<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>连接数据库</title>


</head>
<body>
<div class="window-body">
    <div class="workspace">
        <div class="article">
            <div class="kancloud-markdown-body">
                <div id="s1436920817"><p>如果应用需要使用数据库，必须配置数据库连接信息，数据库的配置文件有多种定义方式。</p>
<h2><a id="_2"></a>配置文件</h2>
<p>在全局或者应用配置目录（不清楚配置目录位置的话参考配置章节）下面的<code>database.php</code>中（后面统称为数据库配置文件）配置下面的数据库参数：</p>
<div class="ಠcopy-code-container"><pre><code class="ಠhighlight-container"><span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token string">'default'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span>    <span class="token string">'mysql'</span><span class="token punctuation">,</span>
    <span class="token string">'connections'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span>    <span class="token punctuation">[</span>
        <span class="token string">'mysql'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span>    <span class="token punctuation">[</span>
            <span class="token comment">// 数据库类型</span>
            <span class="token string">'type'</span>        <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
            <span class="token comment">// 服务器地址</span>
            <span class="token string">'hostname'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库名</span>
            <span class="token string">'database'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'thinkphp'</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库用户名</span>
            <span class="token string">'username'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库密码</span>
            <span class="token string">'password'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">''</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库连接端口</span>
            <span class="token string">'hostport'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">''</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库连接参数</span>
            <span class="token string">'params'</span>      <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库编码默认采用utf8</span>
            <span class="token string">'charset'</span>     <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库表前缀</span>
            <span class="token string">'prefix'</span>      <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'think_'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div>
<p>新版采用多类型的方式配置，方便切换数据库。</p>
<p><code>default</code>配置用于设置默认使用的数据库连接配置。<br><code>connections</code>配置具体的数据库连接信息，<code>default</code>配置参数定义的连接配置必须要存在。</p>
<p><code>type</code>参数用于指定数据库类型</p>
<table><thead><tr><th>type</th><th>数据库</th></tr></thead><tbody><tr><td>mysql</td><td>MySQL</td></tr><tr><td>sqlite</td><td>SqLite</td></tr><tr><td>pgsql</td><td>PostgreSQL</td></tr><tr><td>sqlsrv</td><td>SqlServer</td></tr><tr><td>mongo</td><td>MongoDb</td></tr><tr><td>oracle</td><td>Oracle</td></tr></tbody></table>
<p>每个应用可以设置独立的数据库连接参数，通常直接更改<code>default</code>参数即可：</p>
<div class="ಠcopy-code-container"><pre><code class="ಠhighlight-container"><span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token string">'default'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span>    <span class="token string">'admin'</span><span class="token punctuation">,</span> 
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div>
<h3><a id="_57"></a>连接参数</h3>
<p>可以针对不同的连接需要添加数据库的连接参数（具体的连接参数可以参考PHP手册），内置采用的参数包括如下：</p>
<div class="ಠcopy-code-container"><pre><code class="ಠhighlight-container">PDO<span class="token punctuation">:</span><span class="token punctuation">:</span>ATTR_CASE              <span class="token operator">=</span><span class="token operator">&gt;</span> PDO<span class="token punctuation">:</span><span class="token punctuation">:</span>CASE_NATURAL<span class="token punctuation">,</span>
PDO<span class="token punctuation">:</span><span class="token punctuation">:</span>ATTR_ERRMODE           <span class="token operator">=</span><span class="token operator">&gt;</span> PDO<span class="token punctuation">:</span><span class="token punctuation">:</span>ERRMODE_EXCEPTION<span class="token punctuation">,</span>
PDO<span class="token punctuation">:</span><span class="token punctuation">:</span>ATTR_ORACLE_NULLS      <span class="token operator">=</span><span class="token operator">&gt;</span> PDO<span class="token punctuation">:</span><span class="token punctuation">:</span>NULL_NATURAL<span class="token punctuation">,</span>
PDO<span class="token punctuation">:</span><span class="token punctuation">:</span>ATTR_STRINGIFY_FETCHES <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
PDO<span class="token punctuation">:</span><span class="token punctuation">:</span>ATTR_EMULATE_PREPARES  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
</code></pre></div>
<p>在数据库配置文件中设置的<code>params</code>参数中的连接配置将会和内置的设置参数合并，如果需要使用长连接，并且返回数据库的小写列名，可以在数据库配置文件中增加下面的定义：</p>
<div class="ಠcopy-code-container"><pre><code class="ಠhighlight-container"><span class="token string">'params'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
    \PDO<span class="token punctuation">:</span><span class="token punctuation">:</span>ATTR_PERSISTENT   <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    \PDO<span class="token punctuation">:</span><span class="token punctuation">:</span>ATTR_CASE         <span class="token operator">=</span><span class="token operator">&gt;</span> \PDO<span class="token punctuation">:</span><span class="token punctuation">:</span>CASE_LOWER<span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div>
<blockquote class="default"><p>你可以在<code>params</code>参数里面配置任何PDO支持的连接参数。</p></blockquote>
<h2><a id="_80"></a>切换连接</h2>
<p>我们可以在数据库配置文件中定义多个连接信息</p>
<div class="ಠcopy-code-container"><pre><code class="ಠhighlight-container"><span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token string">'default'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span>    <span class="token string">'mysql'</span><span class="token punctuation">,</span>
    <span class="token string">'connections'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span>    <span class="token punctuation">[</span>
        <span class="token string">'mysql'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span>    <span class="token punctuation">[</span>
            <span class="token comment">// 数据库类型</span>
            <span class="token string">'type'</span>        <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
            <span class="token comment">// 服务器地址</span>
            <span class="token string">'hostname'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库名</span>
            <span class="token string">'database'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'thinkphp'</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库用户名</span>
            <span class="token string">'username'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库密码</span>
            <span class="token string">'password'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">''</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库连接端口</span>
            <span class="token string">'hostport'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">''</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库连接参数</span>
            <span class="token string">'params'</span>      <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库编码默认采用utf8</span>
            <span class="token string">'charset'</span>     <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库表前缀</span>
            <span class="token string">'prefix'</span>      <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'think_'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'demo'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span>    <span class="token punctuation">[</span>
            <span class="token comment">// 数据库类型</span>
            <span class="token string">'type'</span>        <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
            <span class="token comment">// 服务器地址</span>
            <span class="token string">'hostname'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库名</span>
            <span class="token string">'database'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'demo'</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库用户名</span>
            <span class="token string">'username'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库密码</span>
            <span class="token string">'password'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">''</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库连接端口</span>
            <span class="token string">'hostport'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">''</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库连接参数</span>
            <span class="token string">'params'</span>      <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库编码默认采用utf8</span>
            <span class="token string">'charset'</span>     <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span>
            <span class="token comment">// 数据库表前缀</span>
            <span class="token string">'prefix'</span>      <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'think_'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div>
<p>我们可以调用<code>Db::connect</code>方法动态配置数据库连接信息，例如：</p>
<div class="ಠcopy-code-container"><pre><code class="ಠhighlight-container">\think\facade\Db<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'demo'</span><span class="token punctuation">)</span>
	<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<blockquote class="danger"><p><code>connect</code>方法必须在查询的最开始调用，而且必须紧跟着调用查询方法，否则可能会导致部分查询失效或者依然使用默认的数据库连接。</p></blockquote>
<p>动态连接数据库的<code>connect</code>方法仅对当次查询有效。</p>
<blockquote class="danger"><p>这种方式的动态连接和切换数据库比较方便，经常用于多数据库连接的应用需求。</p></blockquote>
<h2><a id="_145"></a>模型类定义</h2>
<p>如果某个模型类里面定义了<code>connection</code>属性的话，则该模型操作的时候会自动按照给定的数据库配置进行连接，而不是配置文件中设置的默认连接信息，例如：</p>
<div class="ಠcopy-code-container"><pre><code class="ಠhighlight-container"><span class="token operator">&lt;</span><span class="token operator">?</span>php
namespace app\index\model<span class="token punctuation">;</span>

use think\Model<span class="token punctuation">;</span>

class <span class="token class-name">User</span> extends <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    protected $connection <span class="token operator">=</span> <span class="token string">'demo'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div>
<blockquote class="default"><p>需要注意的是，ThinkPHP的数据库连接是惰性的，所以并不是在实例化的时候就连接数据库，而是在有实际的数据操作的时候才会去连接数据库。</p></blockquote>
<h2><a id="_163"></a>配置参数参考</h2>
<p>下面是默认支持的数据库连接信息：</p>
<table><thead><tr><th>参数名</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>type</td><td>数据库类型</td><td>无</td></tr><tr><td>hostname</td><td>数据库地址</td><td>127.0.0.1</td></tr><tr><td>database</td><td>数据库名称</td><td>无</td></tr><tr><td>username</td><td>数据库用户名</td><td>无</td></tr><tr><td>password</td><td>数据库密码</td><td>无</td></tr><tr><td>hostport</td><td>数据库端口号</td><td>无</td></tr><tr><td>dsn</td><td>数据库连接dsn信息</td><td>无</td></tr><tr><td>params</td><td>数据库连接参数</td><td>空</td></tr><tr><td>charset</td><td>数据库编码</td><td>utf8</td></tr><tr><td>prefix</td><td>数据库的表前缀</td><td>无</td></tr><tr><td>deploy</td><td>数据库部署方式:0 集中式(单一服务器),1 分布式(主从服务器)</td><td>0</td></tr><tr><td>rw_separate</td><td>数据库读写是否分离 主从式有效</td><td>false</td></tr><tr><td>master_num</td><td>读写分离后 主服务器数量</td><td>1</td></tr><tr><td>slave_no</td><td>指定从服务器序号</td><td>无</td></tr><tr><td>fields_strict</td><td>是否严格检查字段是否存在</td><td>true</td></tr><tr><td>fields_cache</td><td>是否开启字段缓存</td><td>false</td></tr><tr><td>trigger_sql</td><td>是否开启SQL监听</td><td>true</td></tr><tr><td>auto_timestamp</td><td>自动写入时间戳字段</td><td>false</td></tr><tr><td>query</td><td>指定查询对象</td><td>think\db\Query</td></tr></tbody></table>
<p>常用数据库连接参数（<code>params</code>）可以参考<a href="http://php.net/manual/zh/pdo.constants.php" target="_blank">PHP在线手册</a>中的以<code>PDO::ATTR_</code>开头的常量。</p>
<p>如果同时定义了 参数化数据库连接信息 和 dsn信息，则会优先使用dsn信息。</p>
<blockquote class="danger"><p>如果是使用<code>pgsql</code>数据库驱动的话，请先导入 <code>thinkphp/library/think/db/connector/pgsql.sql</code>文件到数据库执行。</p></blockquote>
<h2><a id="_195"></a>断线重连</h2>
<p>如果你使用的是长连接或者命令行，在超出一定时间后，数据库连接会断开，这个时候你需要开启断线重连才能确保应用不中断。</p>
<p>在数据库连接配置中设置：</p>
<div class="ಠcopy-code-container"><pre><code class="ಠhighlight-container"><span class="token comment">// 开启断线重连</span>
<span class="token string">'break_reconnect'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
</code></pre></div>
<p>开启后，系统会自动判断数据库断线并尝试重新连接。大多数情况下都能自动识别，如果在一些特殊的情况下或者某些数据库驱动的断线标识错误还没有定义，支持配置下面的信息：</p>
<div class="ಠcopy-code-container"><pre><code class="ಠhighlight-container"><span class="token comment">// 断线标识字符串</span>
<span class="token string">'break_match_str'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
	<span class="token string">'error with'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div>
<p>在 <code>break_match_str</code>配置中加入你的数据库错误信息关键词。</p>
</div>
            </div>
        </div>
    </div>
</div>
</body>
<link rel="stylesheet" href="css/tzhhone.css">
<link rel="stylesheet" href="css/style.css">
<style type="text/css" data-react-helmet="true">

    pre {
        background: #f9fafa;
        border: 1px solid #ded9d9;
    }

    code {
        background: #f9fafa;
        border: 1px solid #ded9d9;
        margin: 0px 5px;
        padding: 2px 6px;
    }

    pre code {
        border: none;
        padding: 0px;
        margin: 0px;
    }

    .default {
        border-left: 5px solid #5bc0de;
        margin: 8px 0;
        padding: 8px 16px;
        background-color: #f4f8fa;
        color: #5bc0de;
    }

    strong {
        background-color: yellow;
        padding: 2px 5px;
        font-weight: 600;
    }

    h2 {
        font-size: 30px;
        font-weight: 400;
        line-height: 1.1;
        color: #222223;
        margin: 10px 0px;
        font-family: "Georgia", "Xin Gothic", "Hiragino Sans GB", "Droid Sans Fallback", "Microsoft YaHei", "SimSun", sans-serif;
    }

    h3 {

        font-size: 24px;
        font-weight: 400;
        font-family: "Georgia", "Xin Gothic", "Hiragino Sans GB", "Droid Sans Fallback", "Microsoft YaHei", "SimSun", sans-serif;
    }

    blockquote p {
        margin-bottom: 0.46em;
    }

    p {
        line-height: 30px;
        margin-top: 0;
        margin-bottom: 1.46em;
        font: 300 17px/1.62 "Georgia", "Xin Gothic", "Hiragino Sans GB", "Droid Sans Fallback", "Microsoft YaHei", sans-serif;
    }

    table {
        line-height: 30px;
        font-family: IBM Plex Mono, Space Grotesk, Roboto Slab, Microsoft YaHei, sans-serif;
        font-weight: 300;
        font-size: 17px;
    }

    li {
        line-height: 30px;
        font-family: "Georgia", "Xin Gothic", "Hiragino Sans GB", "Droid Sans Fallback", "Microsoft YaHei", "SimSun", sans-serif;
        font-weight: 300;
        font-size: 17px;
    }
</style>
</html>